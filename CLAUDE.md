# Ultracode V2 - Technical Documentation

## Project Overview

Ultracode V2 is an autonomous coding agent with a **feature-based development pipeline**. It transforms from a task-based MAKER architecture (V1) into a comprehensive project management system that can autonomously plan, implement, and test software features with human oversight.

### Core Architecture Shift

**V1 (MAKER)**: Task â†’ Steps â†’ Voting â†’ Apply
**V2 (Feature Pipeline)**: Project â†’ Features â†’ Subtasks â†’ Execution â†’ Testing â†’ Git Commits

## System Architecture

### 1. **SQLite Persistence Layer** (`featureStore.js`)

Replaces JSON-based storage with a robust SQLite database:

**Tables:**
- `projects`: Project metadata, model configurations, folder paths
- `features`: Feature definitions with A/B/C priorities, dependencies, DoD
- `subtasks`: Atomic implementation steps generated by planner
- `events`: Complete audit log of all system events
- `wizard_messages`: Chat history from project creation wizard

**Key Features:**
- WAL mode for concurrent access
- Foreign key constraints for data integrity
- Dependency validation (prevents circular dependencies)
- Order tracking for feature execution sequence
- Full event sourcing for debugging

### 2. **3-Page Project Creation Wizard**

#### **Page 1: Project Basics** (`wizardAgent.js:34-107`)
- Input: Project name, description
- Creates folder structure
- Initializes git repository
- Validates folder availability

#### **Page 2: AI-Powered Project Clarification** (`wizardAgent.js:110-179`)
**Enhanced System Prompt** (Just implemented):
- Structured conversation workflow (Restate â†’ Ask â†’ Recommend â†’ Update)
- Comprehensive requirements checklist (Auth, Data Model, NFRs, Testing)
- Web research integration via Tavily API
- Priority-based feature extraction (A/B/C)
- Definition of Done (DoD) per feature with automated/manual checks

**Output Format:**
```
===PROJECT_MD===
[Structured markdown with sections: Overview, Goals/Non-Goals, Stack, Architecture, Testing, Development Rules, References]
===END_PROJECT_MD===

===FEATURES_JSON===
{
  "features": [
    {
      "id": "F001",
      "name": "User Authentication",
      "priority": "A",
      "definition_of_done": [
        {"type": "automated", "description": "All auth tests pass"},
        {"type": "manual", "description": "Login flow works in browser"}
      ]
    }
  ]
}
===END_FEATURES_JSON===
```

**Extraction Logic** (`wizardAgent.js:505-539`):
- Regex-based block extraction
- Robust JSON parsing with error handling
- Fallback to legacy format if blocks not found
- Stores both `projectMd` and `featuresJson` in wizard state

#### **Page 3: Model Selection**
- Dropdown for Planner Model (strong reasoning model)
- Dropdown for Executor Model (code generation model)
- Dropdown for Voter Model (voting/validation model)
- Dynamic provider registration on-the-fly

### 3. **Feature Management System** (`featureManager.js`)

**Lifecycle:**
```
pending â†’ running â†’ completed â†’ verified
          â†“              â†“
       paused        failed
          â†“
       blocked (dependencies not met)
```

**Core Methods:**
- `executeFeature(featureId)`: Main execution orchestrator
  1. Validates dependencies
  2. Plans feature into subtasks (if not already planned)
  3. Executes subtasks sequentially
  4. Generates technical summary
  5. Git commit (if enabled)

- `executeNextRunnable(projectId)`: Smart execution queue
  - Respects priority order (A > B > C)
  - Checks dependency completion
  - Executes highest priority runnable feature

**Dependency System:**
- Features can depend on other features (`depends_on` field)
- Validation prevents circular dependencies
- Blocked features wait for dependencies to complete
- Frontend shows lock icon for blocked features

### 4. **Feature Planner** (`featurePlanner.js`)

Decomposes features into atomic subtasks using LLM:

**Input:**
- Feature description
- Project context (project.md)
- Completed features (for learning patterns)

**Output:**
```javascript
{
  "subtasks": [
    {
      "intent": "Create LoginForm component with email/password fields",
      "apply": {
        "type": "writeFile",
        "path": "src/components/LoginForm.jsx"
      }
    }
  ]
}
```

**Apply Types:**
- `writeFile`: Create or replace entire file
- `appendFile`: Add content to existing file
- `editFile`: Targeted edits to existing file

**Context Building:**
- Loads `project.md` for guidelines
- Loads `features.json` for existing features
- Loads completed feature summaries for patterns
- Passes to planner model with structured prompt

### 5. **UI Implementation**

#### **Frontend Stack:**
- Vanilla JavaScript (no build step)
- TailwindCSS via CDN
- Marked.js for Markdown rendering (chat messages)
- Highlight.js for code syntax highlighting
- SSE (Server-Sent Events) for live updates

#### **3-Column Dashboard Layout** (`public/index.html:85-169`)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Features    â”‚  Subtasks    â”‚  Terminal      â”‚
â”‚  (Priority)  â”‚  (Status)    â”‚  (Live Logs)   â”‚
â”‚              â”‚              â”‚                â”‚
â”‚  A: âœ“ Auth   â”‚  â˜‘ Created   â”‚  â–¶ Starting... â”‚
â”‚  A: â— DB     â”‚  â³ Running  â”‚  âœ“ Completed   â”‚
â”‚  B: â—‹ Dark   â”‚  â˜ Pending   â”‚  [Files]       â”‚
â”‚              â”‚              â”‚                â”‚
â”‚  [+ Add]     â”‚  [Chat]      â”‚                â”‚
â”‚  [Execute]   â”‚              â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Left Column** (`public/ui.js:319-343`):
- Feature list with priority badges (A=red, B=yellow, C=blue)
- Status indicators (â—‹ pending, â— running, âœ“ completed, âœ• failed)
- Dependency lock icons
- Execute Next button (smart queue)
- Add Feature modal

**Middle Column** (`public/ui.js:400-492`):
- Selected feature details
- Subtask list with status checkboxes
- Feature chat for clarifications/adjustments
- Real-time subtask progress

**Right Column**:
- Terminal log with live SSE updates
- File tree browser
- Syntax-highlighted file preview

#### **Wizard UI** (`public/ui.js:1045-1447`)

**State Management:**
```javascript
state.wizard = {
  currentPage: 1,
  chatHistory: [],
  projectName: '',
  projectDescription: '',
  summary: null,
  sessionId: 'wizard-' + timestamp
}
```

**Model Selection Dropdown:**
- Probes all configured providers (OpenAI, Anthropic, Gemini, LM Studio)
- Groups by provider type
- Auto-selects `gpt-4o-mini` if available
- Dynamic provider registration on chat

**Chat Implementation:**
- Markdown rendering for AI responses
- Plain text for user messages
- Typing indicator animation
- Web search button (Tavily integration)
- Generate Summary button

### 6. **SSE Event System** (`public/ui.js:924-1039`)

**Event Types:**
```javascript
// Feature events
'feature-started'
'feature-planning'
'feature-planned'
'feature-completed'
'feature-failed'
'feature-paused'

// Subtask events
'subtask-started'
'subtask-completed'
'subtask-failed'

// Legacy task events (V1 compatibility)
'step-start'
'step-completed'
'task-completed'
```

**Live UI Updates:**
- Feature list refreshes on status changes
- Subtask list updates during execution
- Terminal log appends in real-time
- Progress indicators animate
- No polling required

### 7. **Git Integration** (`src/gitCommitter.js`)

**Feature-Level Commits:**
```
feat(A): User Authentication

Priority: A (Essential)
Subtasks: 5 completed
Technical Summary: JWT-based auth with refresh tokens...

[Ultracode Auto-Commit]
```

**Commit Strategy:**
- One commit per completed feature
- Includes all modified files from subtasks
- Technical summary in commit body
- Priority tag in subject line

## Implementation Progress

### âœ… Completed (Phases 1-5)

1. **Phase 1**: SQLite schema with full CRUD operations
2. **Phase 2**: Wizard backend with Tavily web search
3. **Phase 3**: Feature management with dependency system
4. **Phase 4**: Complete wizard UI with 3 pages
5. **Phase 5**: 3-column dashboard with SSE live updates

### ğŸ”„ Just Completed

- **Improved System Prompt**: Structured conversation workflow with comprehensive checklist
- **Block-Based Output**: `===PROJECT_MD===` and `===FEATURES_JSON===` extraction
- **DoD Support**: Definition of Done with automated/manual checks
- **Markdown Rendering**: Chat messages render with syntax highlighting
- **Dynamic Provider Registration**: Auto-register models on first use

### â³ Pending (Phases 6-10)

6. **Phase 6: Puppeteer Testing**
   - `testRunner.js`: Screenshot-based UI verification
   - `serverManager.js`: Auto-start dev servers (Node/PHP/etc)
   - Flow: Feature completes â†’ Server starts â†’ Screenshot â†’ LLM verifies against DoD
   - Update feature status to `verified` or `failed`

7. **Phase 7: project.md Context Flow**
   - `contextBuilder.js`: Smart context assembly for planner/executor
   - Load project.md guidelines
   - Add completed feature summaries
   - Inject into planner prompt
   - Frontend editor modal for project.md (already exists!)

8. **Phase 8: Git Integration**
   - Already implemented in `gitCommitter.js`
   - Hook into `featureManager.js:280-288`
   - Test commit creation
   - Add git push option

9. **Phase 9: Token Tracking UI**
   - `resourceMonitor.js`: Project-level token aggregation
   - Display in header: "GPT-4: 15.2k tokens $1.20"
   - Per-model breakdown
   - Active agent indicator

10. **Phase 10: V1 â†’ V2 Migration**
    - `migration.js`: Convert tasks.json to SQLite
    - Backup strategy
    - Feature creation from old tasks
    - Subtask conversion
    - Deprecate legacy endpoints

## Testing Checklist

### Wizard Flow
- [ ] Create new project with unique name
- [ ] Chat with AI about requirements (test Markdown rendering)
- [ ] Trigger web search (requires Tavily API key)
- [ ] Generate summary (test block extraction)
- [ ] Verify project.md contains all sections
- [ ] Verify features.json has DoD arrays
- [ ] Check SQLite database has features
- [ ] Test model selection dropdowns

### Feature Execution
- [ ] Add feature manually via UI
- [ ] Set dependencies between features
- [ ] Execute feature (should auto-plan subtasks)
- [ ] Verify subtasks appear in middle column
- [ ] Watch SSE updates in terminal
- [ ] Check feature completes successfully
- [ ] Verify technical summary generated
- [ ] Test pause/resume functionality
- [ ] Test blocked feature (dependency not met)

### UI/UX
- [ ] Test all 3 columns resize properly
- [ ] Feature priority colors correct (A/B/C)
- [ ] Status badges update in real-time
- [ ] Chat markdown renders properly
- [ ] Code blocks have syntax highlighting
- [ ] File tree loads and displays
- [ ] Terminal log auto-scrolls
- [ ] Modals open/close correctly

### Edge Cases
- [ ] Create feature with circular dependency (should fail)
- [ ] Execute feature without API keys (should error gracefully)
- [ ] Test with invalid model name
- [ ] Test with empty project name
- [ ] Test summary extraction with malformed response
- [ ] Test JSON parsing errors

## Known Issues / TODOs

1. **Session ID vs Project ID Confusion**
   - Wizard uses temporary `sessionId` before project creation
   - Fixed with auto-initialization in `processChat()`
   - Should consolidate after testing

2. **Provider Registration Timing**
   - Models from UI dropdown need dynamic registration
   - Fixed with `ensureProvider()` helper
   - Consider pre-loading all providers at startup

3. **DoD Format Inconsistency**
   - Database stores DoD as TEXT (string)
   - features.json has DoD as array of objects
   - Conversion logic in `finalizeWizard()` handles this
   - Consider migrating DB to JSON column

4. **Error Handling**
   - LLM timeouts not handled gracefully
   - Tavily API failures should show user-friendly message
   - Subtask failures should allow retry

5. **Performance**
   - Large feature lists may slow down UI
   - Consider pagination or virtualization
   - SSE events for all projects (should filter by active project)

## API Endpoints

### Wizard
- `POST /api/wizard/start` - Initialize wizard session
- `POST /api/wizard/chat` - Chat message (with chatModel param)
- `POST /api/wizard/web-search` - Trigger Tavily search
- `POST /api/wizard/extract-summary` - Generate final files
- `POST /api/wizard/finalize` - Create project with selected models
- `POST /api/wizard/cancel` - Cancel wizard session

### Projects
- `GET /api/projects` - List all projects
- `POST /api/projects/create` - Create project folder
- `GET /api/projects/:id` - Get project details
- `GET /api/projects/:id/project-md` - Load project.md
- `POST /api/projects/:id/project-md` - Save project.md
- `POST /api/projects/:id/execute-next` - Execute next runnable feature

### Features
- `GET /api/features?projectId=X` - List project features
- `POST /api/features` - Create new feature
- `PUT /api/features/:id` - Update feature
- `DELETE /api/features/:id` - Delete feature
- `POST /api/features/:id/execute` - Execute specific feature
- `POST /api/features/:id/pause` - Pause running feature
- `GET /api/features/:id/subtasks` - Get feature subtasks
- `POST /api/features/:id/chat` - Chat for feature clarification

### Config
- `GET /api/config/keys` - Get API keys (masked)
- `POST /api/config/keys` - Save API keys
- `POST /api/providers/probe-models` - List available models

### SSE
- `GET /api/events` - Server-Sent Events stream

## File Structure

```
Ultracode/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ server.js              # HTTP server + API endpoints
â”‚   â”œâ”€â”€ featureStore.js        # SQLite database wrapper
â”‚   â”œâ”€â”€ featureManager.js      # Feature lifecycle orchestration
â”‚   â”œâ”€â”€ featurePlanner.js      # Feature â†’ Subtasks decomposition
â”‚   â”œâ”€â”€ wizardAgent.js         # 3-page wizard logic
â”‚   â”œâ”€â”€ orchestrator.js        # Step execution (MAKER engine)
â”‚   â”œâ”€â”€ llmRegistry.js         # LLM provider management
â”‚   â”œâ”€â”€ providerFactory.js     # Provider instantiation
â”‚   â”œâ”€â”€ gitCommitter.js        # Git integration
â”‚   â”œâ”€â”€ projectGuard.js        # Filesystem sandboxing
â”‚   â”œâ”€â”€ executionGuard.js      # Command safety
â”‚   â””â”€â”€ providers/
â”‚       â”œâ”€â”€ openaiProvider.js
â”‚       â”œâ”€â”€ claudeProvider.js
â”‚       â”œâ”€â”€ geminiProvider.js
â”‚       â”œâ”€â”€ lmstudioProvider.js
â”‚       â””â”€â”€ tavilyProvider.js   # Web search
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ index.html             # Main UI (wizard + dashboard)
â”‚   â””â”€â”€ ui.js                  # Frontend logic (~1500 LOC)
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ ultracode.db           # SQLite database (auto-created)
â”‚   â”œâ”€â”€ config.json            # API keys, settings
â”‚   â””â”€â”€ audit.log              # Event log
â”œâ”€â”€ workspaces/                # Project folders created here
â”‚   â””â”€â”€ {project-name}/
â”‚       â”œâ”€â”€ project.md
â”‚       â”œâ”€â”€ features.json
â”‚       â””â”€â”€ src/               # Generated code
â”œâ”€â”€ CLAUDE.md                  # This file
â””â”€â”€ package.json               # (none - zero dependencies!)
```

## Next Steps

1. **Test the improved wizard** with the new system prompt
2. **Verify block extraction** works with real LLM responses
3. **Implement Phase 6** (Puppeteer testing) for automated verification
4. **Add retry logic** for failed subtasks
5. **Improve error messages** in UI (less alerts, more inline)
6. **Add project deletion** with confirmation modal
7. **Implement feature reordering** with drag-and-drop
8. **Add export/import** for features.json

---

**Last Updated**: 2025-01-17
**Current Version**: V2 Alpha (Phases 1-5 complete)
**Status**: Ready for testing with improved wizard system prompt
